<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Udhaar Tracker ‚Äî Digital Khata</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Nastaliq+Urdu&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    
    <!-- jsPDF & html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-primary: #FFFDF5;
            --bg-secondary: #FFFFFF;
            --gold-primary: #C9A84C;
            --gold-light: #F0D080;
            --gold-dark: #A07830;
            --gold-gradient: linear-gradient(135deg, #C9A84C, #F0D080);
            --text-primary: #1A1400;
            --text-secondary: #6B5C2E;
            --border: #E8D5A3;
            --success: #2E7D32;
            --danger: #C62828;
            --white: #FFFFFF;
            --shadow: 0 4px 24px rgba(201, 168, 76, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .urdu-font {
            font-family: 'Noto Nastaliq Urdu', serif !important;
            line-height: 2.5;
        }

        .hidden {
            display: none !important;
        }

        /* Layout Containers */
        .container {
            width: 100%;
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Auth Screen */
        #auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: var(--bg-primary);
        }

        .auth-card {
            background: var(--white);
            border-top: 4px solid var(--gold-primary);
            border-radius: 16px;
            padding: 32px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 4px 24px rgba(201,168,76,0.2);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 24px;
        }

        .auth-logo h1 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .auth-logo h1 span {
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-logo p {
            color: #888;
            font-size: 14px;
            margin-top: 4px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            font-weight: 600;
            color: #888;
            transition: all 0.3s ease;
            background: white;
            border-bottom: 1px solid var(--border);
        }

        .auth-tab.active {
            background: var(--gold-gradient);
            color: white;
            font-weight: 700;
            border-bottom: none;
        }

        .auth-error {
            color: var(--danger);
            font-size: 13px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        input, textarea {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            padding: 12px 16px;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s;
            outline: none;
        }

        input:focus, textarea:focus {
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 3px rgba(201, 168, 76, 0.2);
        }

        /* Buttons */
        .btn {
            cursor: pointer;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 700;
            border: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 15px;
        }

        .btn:hover {
            opacity: 0.9;
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--gold-gradient);
            color: var(--text-primary);
            width: 100%;
        }

        .btn-outline-success {
            background: #F0FFF4;
            color: var(--success);
            border: 1px solid var(--success);
        }

        .btn-outline-gold {
            background: #FFFFFF;
            color: var(--gold-dark);
            border: 1px solid var(--gold-primary);
        }

        .btn-outline-danger {
            background: #FFF0F0;
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .btn-outline-blue {
            background: #F0F7FF;
            color: #0056b3;
            border: 1px solid #0056b3;
        }

        /* Dashboard Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            margin-bottom: 20px;
            background: var(--gold-gradient);
            box-shadow: 0 4px 12px rgba(201,168,76,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            color: white;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo-container {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-logo-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
            object-fit: cover;
        }

        .header-logo-emoji {
            font-size: 28px;
        }

        .shop-details {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }

        .shop-details h2 {
            font-size: 18px;
            line-height: 1.2;
            margin: 0;
        }

        .btn-edit-shop {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.6);
            color: white;
            padding: 1px 6px;
            font-size: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.3s;
            width: fit-content;
        }

        .btn-edit-shop:hover {
            background: rgba(255,255,255,0.2);
            border-color: white;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn-logout-header {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 4px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        .lang-toggle {
            background: var(--white);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(201,168,76,0.2);
        }

        .summary-card.customers { border-top: 4px solid var(--gold-primary); }
        .summary-card.outstanding { border-top: 4px solid var(--danger); }
        .summary-card.received { border-top: 4px solid var(--success); }

        .summary-icon {
            font-size: 24px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: var(--bg-primary);
        }

        .summary-details h4 {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-details p {
            font-size: 28px;
            font-weight: 700;
            color: var(--gold-dark);
        }

        /* Add Customer Card */
        .card {
            background: var(--white);
            border: 1px solid var(--border);
            border-top: 3px solid var(--gold-primary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--gold-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Search Bar */
        .search-container {
            position: relative;
            margin-bottom: 24px;
        }

        .search-container i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gold-primary);
            font-style: normal;
        }

        .search-container input {
            background: white;
            border: 2px solid #E8D5A3;
            border-radius: 12px;
            padding: 14px 16px 14px 44px;
        }

        .search-container input:focus {
            border-color: var(--gold-primary);
        }

        /* Customer List */
        .customer-card {
            border-left: 4px solid var(--gold-primary);
            border-top: none;
            transition: 0.3s ease;
        }

        .customer-card:hover {
            box-shadow: 0 8px 24px rgba(201, 168, 76, 0.15);
            transform: translateY(-2px);
        }

        .customer-card.cleared {
            border-left: 4px solid var(--success);
            background: #F0FFF4;
        }

        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .customer-info {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .avatar {
            width: 48px;
            height: 48px;
            background: var(--gold-gradient);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
        }

        .customer-name-phone h4 {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-edit-cust {
            background: transparent;
            border: none;
            color: var(--gold-primary);
            cursor: pointer;
            font-size: 14px;
            padding: 2px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-edit-cust:hover {
            transform: scale(1.2);
            color: var(--gold-dark);
        }

        .customer-name-phone p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .customer-balance {
            text-align: right;
        }

        .balance-amount {
            font-size: 22px;
            font-weight: 800;
            color: var(--danger);
        }

        .cleared .balance-amount {
            color: var(--success);
        }

        .balance-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .cleared-badge {
            background: var(--success);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 4px;
            display: inline-block;
        }

        .customer-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .stat-item span {
            display: block;
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .stat-item p {
            font-size: 14px;
            font-weight: 600;
        }

        .customer-notes {
            font-size: 13px;
            font-style: italic;
            color: var(--text-secondary);
            margin-bottom: 16px;
            padding-left: 10px;
            border-left: 2px solid var(--gold-light);
        }

        .customer-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .customer-actions .btn {
            height: 40px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 8px;
        }

        /* Payment Forms & History */
        .inline-form {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed var(--border);
            display: none;
        }

        .history-table-container {
            margin-top: 16px;
            overflow-x: auto;
            display: none;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: var(--gold-gradient);
            color: var(--white);
            text-align: left;
            padding: 12px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        tr:nth-child(even) {
            background: #FFFDF5;
        }

        tr:hover {
            background: #FFF8E7;
        }

        /* Toasts */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            width: auto;
            min-width: 300px;
        }

        .toast {
            padding: 14px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            margin-bottom: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            animation: slideDown 0.3s ease forwards;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }

        /* Footer */
        footer {
            text-align: center;
            padding: 40px 0;
            color: #6B5C2E;
            font-size: 13px;
            border-top: 1px solid var(--border);
            margin-top: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .customer-actions {
                grid-template-columns: 1fr;
            }
            .customer-stats {
                grid-template-columns: 1fr;
            }
            .header-actions {
                flex-direction: column;
                align-items: flex-end;
            }
            header {
                align-items: flex-start;
            }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .modal-card {
            background: var(--white);
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            padding: 32px;
            text-align: center;
            border-top: 4px solid var(--gold-primary);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideUp 0.3s ease-out;
        }

        @keyframes modalSlideUp {
            from { transform: translateY(40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .modal-card h3 {
            font-size: 22px;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .modal-card p {
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .logo-preview-container {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .logo-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--gold-primary);
            object-fit: cover;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .logo-note {
            font-size: 11px;
            color: #888;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        .btn-danger-solid {
            background: #C62828;
            color: white;
        }

        .btn-modal-cancel {
            background: white;
            border: 1px solid #E8D5A3;
            color: #1A1400;
        }

        #btn-add-customer {
            height: 52px;
            font-size: 16px;
            border-radius: 12px;
            background: var(--gold-gradient);
            box-shadow: 0 4px 16px rgba(201,168,76,0.4);
        }

        #btn-add-customer:hover {
            box-shadow: 0 6px 20px rgba(201,168,76,0.5);
            transform: scale(1.01);
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="auth-card">
            <div class="auth-logo">
                <h1><span>üìí Udhaar Tracker</span></h1>
                <p id="auth-subtitle">Digital Khata for Your Shop</p>
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')" id="tab-login-label">Login</div>
                <div class="auth-tab" onclick="switchAuthTab('register')" id="tab-register-label">Register</div>
            </div>

            <!-- Login Form -->
            <div id="login-form">
                <div class="form-group">
                    <label id="label-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label id="label-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter password">
                </div>
                <button class="btn btn-primary" style="height: 48px;" onclick="handleLogin()" id="btn-login">Login</button>
                <div id="login-error" class="auth-error">Invalid email or password</div>
            </div>

            <!-- Register Form -->
            <div id="register-form" style="display: none;">
                <div class="form-group">
                    <label id="label-shop-name">Shop Name</label>
                    <input type="text" id="reg-shop-name" placeholder="Enter your shop name">
                </div>
                <div class="form-group">
                    <label id="label-reg-email">Email</label>
                    <input type="email" id="reg-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label id="label-reg-password">Password</label>
                    <input type="password" id="reg-password" placeholder="Min 6 characters">
                </div>
                <div class="form-group">
                    <label id="label-confirm-password">Confirm Password</label>
                    <input type="password" id="reg-confirm-password" placeholder="Repeat password">
                </div>
                <button class="btn btn-primary" style="height: 48px;" onclick="handleRegister()" id="btn-register">Create Account</button>
                <div id="register-error" class="auth-error">Something went wrong</div>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboard-screen" class="hidden">
        <div class="container">
            <header>
                <div class="logo-area">
                    <div id="header-logo-container" class="header-logo-container">üìí</div>
                    <div class="shop-details">
                        <h2 id="display-shop-name">My Shop</h2>
                        <button class="btn-edit-shop" onclick="openShopSettings()">‚úèÔ∏è Edit</button>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="lang-toggle" onclick="toggleLanguage()">EN | ÿßÿ±ÿØŸà</button>
                    <button class="btn-logout-header" onclick="handleLogout()" id="btn-logout">Logout</button>
                </div>
            </header>

            <!-- Summary Cards -->
            <div class="summary-grid">
                <div class="summary-card customers">
                    <div class="summary-icon">üë•</div>
                    <div class="summary-details">
                        <h4 id="summary-total-customers">Total Customers</h4>
                        <p id="count-customers">0</p>
                    </div>
                </div>
                <div class="summary-card outstanding">
                    <div class="summary-icon">üìä</div>
                    <div class="summary-details">
                        <h4 id="summary-total-udhaar">Total Udhaar</h4>
                        <p id="total-outstanding">Rs. 0</p>
                    </div>
                </div>
                <div class="summary-card received">
                    <div class="summary-icon">‚úÖ</div>
                    <div class="summary-details">
                        <h4 id="summary-received-today">Received Today</h4>
                        <p id="total-received-today">Rs. 0</p>
                    </div>
                </div>
            </div>

            <!-- Add Customer Card -->
            <div class="card">
                <div class="card-title">
                    <span>‚ûï</span> <span id="title-add-customer">Add New Customer</span>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label id="label-cust-name">Customer Name</label>
                        <input type="text" id="cust-name" placeholder="Enter full name">
                    </div>
                    <div class="form-group">
                        <label id="label-cust-phone">Phone Number</label>
                        <input type="text" id="cust-phone" placeholder="e.g. 0300-1234567">
                    </div>
                    <div class="form-group">
                        <label id="label-cust-amount">Udhaar Amount</label>
                        <input type="number" id="cust-amount" placeholder="Rs.">
                    </div>
                    <div class="form-group">
                        <label id="label-cust-date">Date</label>
                        <input type="date" id="cust-date">
                    </div>
                </div>
                <div class="form-group">
                    <label id="label-cust-notes">Notes</label>
                    <textarea id="cust-notes" rows="2" placeholder="e.g. Samsung A55 wali udhaar"></textarea>
                </div>
                <button class="btn btn-primary" onclick="addCustomer()" id="btn-add-customer">Add Customer</button>
            </div>

            <!-- Search Bar -->
            <div class="search-container">
                <i>üîç</i>
                <input type="text" id="search-input" placeholder="Search customer by name..." onkeyup="filterCustomers()">
            </div>

            <!-- Customer List -->
            <div id="customer-list">
                <!-- Customer cards will be injected here -->
            </div>

            <footer>
                <p id="footer-text">Udhaar Tracker ‚Äî Digital Khata for Pakistani Shops</p>
            </footer>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-icon">üóëÔ∏è</div>
            <h3 id="modal-title">Delete Customer?</h3>
            <p id="modal-body">Are you sure you want to delete this customer? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn btn-danger-solid" id="confirm-delete-btn">Yes, Delete</button>
                <button class="btn btn-modal-cancel" onclick="closeDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Shop Settings Modal -->
    <div id="shop-settings-modal" class="modal-overlay">
        <div class="modal-card">
            <h3 id="shop-settings-title">Shop Settings</h3>
            
            <div class="logo-preview-container">
                <div id="logo-preview-box" class="logo-preview">üìí</div>
                <p class="logo-note">Recommended: square image</p>
            </div>

            <div class="form-group" style="text-align: left;">
                <label>Shop Logo</label>
                <input type="file" id="shop-logo-input" accept="image/*" onchange="previewLogo(this)">
            </div>

            <div class="form-group" style="text-align: left;">
                <label>Shop Name</label>
                <input type="text" id="settings-shop-name" placeholder="Enter shop name">
            </div>

            <div class="modal-actions" style="flex-direction: column;">
                <button class="btn btn-primary" onclick="saveShopSettings()" id="btn-save-shop">Save Changes</button>
                <button class="btn btn-outline-gold" onclick="closeShopSettings()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Customer Modal -->
    <div id="edit-customer-modal" class="modal-overlay">
        <div class="modal-card">
            <h3 id="edit-customer-title">Edit Customer</h3>
            
            <div class="form-group" style="text-align: left;">
                <label>Customer Name</label>
                <input type="text" id="edit-cust-name" placeholder="Enter name">
            </div>

            <div class="form-group" style="text-align: left;">
                <label>Phone Number</label>
                <input type="text" id="edit-cust-phone" placeholder="Enter phone">
            </div>

            <div class="modal-actions" style="flex-direction: column;">
                <button class="btn btn-primary" onclick="saveCustomerEdit()" id="btn-save-cust-edit">Save Changes</button>
                <button class="btn btn-outline-gold" onclick="closeEditCustomerModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        /*
        Firestore Rules to set in Firebase Console:
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            match /customers/{doc} {
              allow read, write: if request.auth != null 
              && request.auth.uid == (resource == null ? request.auth.uid : resource.data.userId);
            }
            match /payments/{doc} {
              allow read, write: if request.auth != null 
              && request.auth.uid == (resource == null ? request.auth.uid : resource.data.userId);
            }
            match /users/{userId} {
              allow read, write: if request.auth != null 
              && request.auth.uid == userId;
            }
          }
        }
        */

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkU_UPBZ6SH2ze8JGKI8k_48AW7ah-eHU",
            authDomain: "udhaar-tracker-e3543.firebaseapp.com",
            projectId: "udhaar-tracker-e3543",
            storageBucket: "udhaar-tracker-e3543.firebasestorage.app",
            messagingSenderId: "266720326346",
            appId: "1:266720326346:web:3ed24d162f23bd90a97a33",
            measurementId: "G-KLR807V4B7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        db.settings({
            cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
        });

        // State Management
        let currentUser = null;
        let shopName = "My Shop";
        let logoUrl = null;
        let customers = [];
        let currentLang = 'en';
        let isSubmitting = false;
        let customerToDelete = null;
        let customerToEdit = null;

        const translations = {
            en: {
                title: "Udhaar Tracker",
                subtitle: "Digital Khata",
                authSubtitle: "Digital Khata for Your Shop",
                login: "Login",
                register: "Register",
                email: "Email",
                password: "Password",
                shopName: "Shop Name",
                confirmPassword: "Confirm Password",
                createAccount: "Create Account",
                logout: "Logout",
                totalCustomers: "Total Customers",
                totalUdhaar: "Total Udhaar",
                receivedToday: "Received Today",
                addNewCustomer: "Add New Customer",
                customerName: "Customer Name",
                phoneNumber: "Phone Number",
                udhaarAmount: "Udhaar Amount",
                date: "Date",
                notes: "Notes",
                addCustomer: "Add Customer",
                searchPlaceholder: "Search customer by name...",
                remaining: "Remaining",
                paid: "Paid",
                receivePayment: "Receive Payment",
                paymentHistory: "Payment History",
                printKhata: "Print Khata",
                delete: "Delete",
                save: "Save",
                cancel: "Cancel",
                amountReceived: "Amount Received",
                paymentNote: "Payment Note",
                savePayment: "Save Payment",
                noCustomers: "No customers found",
                footer: "Udhaar Tracker ‚Äî Digital Khata for Pakistani Shops",
                cleared: "CLEARED ‚úÖ",
                outstanding: "OUTSTANDING",
                confirmDelete: "Delete customer? This cannot be undone.",
                fillRequired: "Please fill required fields ‚ùå",
                passMismatch: "Passwords do not match ‚ùå",
                regSuccess: "Account created successfully ‚úÖ",
                loginSuccess: "Login successful ‚úÖ",
                custAdded: "Customer added successfully ‚úÖ",
                payReceived: "Payment received ‚úÖ",
                custDeleted: "Customer deleted",
                error: "Something went wrong ‚ùå"
            },
            ur: {
                title: "ÿßÿØ⁄æÿßÿ± Ÿπÿ±€å⁄©ÿ±",
                subtitle: "⁄à€åÿ¨€åŸπŸÑ ⁄©⁄æÿßÿ™€Å",
                authSubtitle: "ÿ¢Ÿæ ⁄©€å ÿØ⁄©ÿßŸÜ ⁄©€í ŸÑ€å€í ⁄à€åÿ¨€åŸπŸÑ ⁄©⁄æÿßÿ™€Å",
                login: "ŸÑÿß⁄Ø ÿßŸÜ",
                register: "ÿ±ÿ¨ÿ≥Ÿπÿ±",
                email: "ÿß€å ŸÖ€åŸÑ",
                password: "Ÿæÿßÿ≥ Ÿàÿ±⁄à",
                shopName: "ÿØ⁄©ÿßŸÜ ⁄©ÿß ŸÜÿßŸÖ",
                confirmPassword: "Ÿæÿßÿ≥ Ÿàÿ±⁄à ⁄©€å ÿ™ÿµÿØ€åŸÇ",
                createAccount: "ÿß⁄©ÿßÿ§ŸÜŸπ ÿ®ŸÜÿßÿ¶€å⁄∫",
                logout: "ŸÑÿß⁄Ø ÿ¢ÿ§Ÿπ",
                totalCustomers: "⁄©ŸÑ ⁄Øÿß€Å⁄©",
                totalUdhaar: "⁄©ŸÑ ÿßÿØ⁄æÿßÿ±",
                receivedToday: "ÿ¢ÿ¨ ⁄©€å ŸàÿµŸàŸÑ€å",
                addNewCustomer: "ŸÜ€åÿß ⁄Øÿß€Å⁄© ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫",
                customerName: "⁄Øÿß€Å⁄© ⁄©ÿß ŸÜÿßŸÖ",
                phoneNumber: "ŸÅŸàŸÜ ŸÜŸÖÿ®ÿ±",
                udhaarAmount: "ÿßÿØ⁄æÿßÿ± ÿ±ŸÇŸÖ",
                date: "ÿ™ÿßÿ±€åÿÆ",
                notes: "ŸÜŸàŸπÿ≥",
                addCustomer: "⁄Øÿß€Å⁄© ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫",
                searchPlaceholder: "ŸÜÿßŸÖ ÿ≥€í ⁄Øÿß€Å⁄© ÿ™ŸÑÿßÿ¥ ⁄©ÿ±€å⁄∫...",
                remaining: "ÿ®ÿßŸÇ€å",
                paid: "ÿßÿØÿß ÿ¥ÿØ€Å",
                receivePayment: "ÿßÿØÿßÿ¶€å⁄Ø€å ŸàÿµŸàŸÑ ⁄©ÿ±€å⁄∫",
                paymentHistory: "ÿßÿØÿßÿ¶€å⁄Ø€å ⁄©€å ÿ™ÿßÿ±€åÿÆ",
                printKhata: "⁄©⁄æÿßÿ™€Å Ÿæÿ±ŸÜŸπ ⁄©ÿ±€å⁄∫",
                delete: "ÿ≠ÿ∞ŸÅ ⁄©ÿ±€å⁄∫",
                save: "ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫",
                cancel: "ŸÖŸÜÿ≥ŸàÿÆ",
                amountReceived: "ŸàÿµŸàŸÑ ÿ¥ÿØ€Å ÿ±ŸÇŸÖ",
                paymentNote: "ÿßÿØÿßÿ¶€å⁄Ø€å ŸÜŸàŸπ",
                savePayment: "ÿßÿØÿßÿ¶€å⁄Ø€å ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫",
                noCustomers: "⁄©Ÿàÿ¶€å ⁄Øÿß€Å⁄© ŸÜ€Å€å⁄∫ ŸÖŸÑÿß",
                footer: "ÿßÿØ⁄æÿßÿ± Ÿπÿ±€å⁄©ÿ± ‚Äî Ÿæÿß⁄©ÿ≥ÿ™ÿßŸÜ€å ÿØ⁄©ÿßŸÜŸà⁄∫ ⁄©€í ŸÑ€å€í ⁄à€åÿ¨€åŸπŸÑ ⁄©⁄æÿßÿ™€Å",
                cleared: "ÿßÿØÿß ÿ¥ÿØ€Å ‚úÖ",
                outstanding: "ÿ®ÿßŸÇ€å ÿßÿØ⁄æÿßÿ±",
                confirmDelete: "⁄Øÿß€Å⁄© ⁄©Ÿà ÿ≠ÿ∞ŸÅ ⁄©ÿ±€å⁄∫ÿü €å€Å ÿπŸÖŸÑ ŸàÿßŸæÿ≥ ŸÜ€Å€å⁄∫ €ÅŸà ÿ≥⁄©ÿ™ÿß€î",
                fillRequired: "ÿ®ÿ±ÿß€Å ⁄©ÿ±ŸÖ ÿ™ŸÖÿßŸÖ ÿ∂ÿ±Ÿàÿ±€å ÿÆÿßŸÜ€í ÿ®⁄æÿ±€å⁄∫ ‚ùå",
                passMismatch: "Ÿæÿßÿ≥ Ÿàÿ±⁄à ŸÖŸÖÿßÿ´ŸÑ ŸÜ€Å€å⁄∫ €Å€å⁄∫ ‚ùå",
                regSuccess: "ÿß⁄©ÿßÿ§ŸÜŸπ ⁄©ÿßŸÖ€åÿßÿ®€å ÿ≥€í ÿ®ŸÜ ⁄Ø€åÿß ‚úÖ",
                loginSuccess: "ŸÑÿß⁄Ø ÿßŸÜ ⁄©ÿßŸÖ€åÿßÿ® ÿ±€Åÿß ‚úÖ",
                custAdded: "⁄Øÿß€Å⁄© ⁄©ÿßŸÖ€åÿßÿ®€å ÿ≥€í ÿ¥ÿßŸÖŸÑ €ÅŸà ⁄Ø€åÿß ‚úÖ",
                payReceived: "ÿßÿØÿßÿ¶€å⁄Ø€å ŸàÿµŸàŸÑ €ÅŸà ⁄Øÿ¶€å ‚úÖ",
                custDeleted: "⁄Øÿß€Å⁄© ÿ≠ÿ∞ŸÅ ⁄©ÿ± ÿØ€åÿß ⁄Ø€åÿß",
                error: "⁄©⁄Ü⁄æ ÿ∫ŸÑÿ∑ €ÅŸà ⁄Ø€åÿß ‚ùå"
            }
        };

        // Auth Observer
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        shopName = data.shopName || "My Shop";
                        logoUrl = data.logoUrl || null;
                        updateHeaderUI();
                    }
                    showScreen('dashboard-screen');
                    fetchData();
                }, err => {
                    console.error("User Data Error:", err);
                    showScreen('dashboard-screen');
                    fetchData();
                });
            } else {
                currentUser = null;
                showScreen('auth-screen');
            }
        });

        function updateHeaderUI() {
            const shopNameText = document.getElementById('display-shop-name');
            const logoContainer = document.getElementById('header-logo-container');
            
            if (shopNameText) shopNameText.innerText = shopName;
            
            if (logoContainer) {
                if (logoUrl) {
                    logoContainer.innerHTML = `<img src="${logoUrl}" class="header-logo-img" alt="Logo">`;
                } else {
                    logoContainer.innerHTML = `<span class="header-logo-emoji">üìí</span>`;
                }
            }
        }

        // Shop Settings Functions
        function openShopSettings() {
            document.getElementById('settings-shop-name').value = shopName;
            const previewBox = document.getElementById('logo-preview-box');
            if (logoUrl) {
                previewBox.innerHTML = `<img src="${logoUrl}" class="logo-preview" style="width:100%; height:100%; border:none;">`;
            } else {
                previewBox.innerHTML = 'üìí';
            }
            document.getElementById('shop-settings-modal').style.display = 'flex';
        }

        function closeShopSettings() {
            document.getElementById('shop-settings-modal').style.display = 'none';
            document.getElementById('shop-logo-input').value = '';
        }

        function previewLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewBox = document.getElementById('logo-preview-box');
                    previewBox.innerHTML = `<img src="${e.target.result}" class="logo-preview" style="width:100%; height:100%; border:none;">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveShopSettings() {
            if (!currentUser) {
                showToast("User not logged in ‚ùå", "error");
                return;
            }
            
            const newName = document.getElementById('settings-shop-name').value.trim();
            const logoFile = document.getElementById('shop-logo-input').files[0];
            const btn = document.getElementById('btn-save-shop');
            
            if (!newName) {
                showToast("Shop name is required ‚ùå", "error");
                return;
            }

            // Disable button and show loading
            btn.disabled = true;
            btn.innerText = "Saving...";

            const finalizeSave = (finalLogoUrl) => {
                db.collection('users').doc(currentUser.uid).set({
                    shopName: newName,
                    logoUrl: finalLogoUrl
                }, { merge: true })
                .then(() => {
                    shopName = newName;
                    logoUrl = finalLogoUrl;
                    updateHeaderUI();
                    closeShopSettings();
                    showToast("Shop updated ‚úÖ");
                })
                .catch(err => {
                    console.error("Firestore Save Error:", err);
                    showToast("Error: " + err.message, "error");
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerText = "Save Changes";
                });
            };

            if (logoFile) {
                // Upload logo first
                const storageRef = storage.ref(`logos/${currentUser.uid}/shop-logo.jpg`);
                storageRef.put(logoFile)
                .then(() => {
                    return storageRef.getDownloadURL();
                })
                .then(url => {
                    finalizeSave(url);
                })
                .catch(err => {
                    console.error("Storage Upload Error:", err);
                    showToast("Error: " + err.message, "error");
                    btn.disabled = false;
                    btn.innerText = "Save Changes";
                });
            } else {
                // No logo file selected, just save name
                finalizeSave(logoUrl);
            }
        }

        // Edit Customer Functions
        function openEditCustomerModal(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer) return;
            
            customerToEdit = customer;
            document.getElementById('edit-cust-name').value = customer.name;
            document.getElementById('edit-cust-phone').value = customer.phone || '';
            document.getElementById('edit-customer-modal').style.display = 'flex';
        }

        function closeEditCustomerModal() {
            document.getElementById('edit-customer-modal').style.display = 'none';
            customerToEdit = null;
        }

        async function saveCustomerEdit() {
            if (!currentUser || !customerToEdit) return;
            
            const newName = document.getElementById('edit-cust-name').value.trim();
            const newPhone = document.getElementById('edit-cust-phone').value.trim();
            const btn = document.getElementById('btn-save-cust-edit');

            if (!newName) return showToast("Name is required", "error");

            // Duplicate check (Name or Phone)
            const newNameLower = newName.toLowerCase();
            const newPhoneClean = newPhone.replace(/[^0-9]/g, '');

            const duplicate = customers.find(c => {
                if (c.id === customerToEdit.id) return false;
                const nameMatch = c.name.toLowerCase() === newNameLower;
                const phoneMatch = newPhone && c.phone && c.phone.replace(/[^0-9]/g, '') === newPhoneClean;
                return nameMatch || phoneMatch;
            });

            if (duplicate) {
                const msg = duplicate.name.toLowerCase() === newNameLower 
                    ? `‚ö†Ô∏è Customer '${newName}' already exists!` 
                    : `‚ö†Ô∏è Phone number '${newPhone}' is already used by ${duplicate.name}!`;
                return showToast(msg, "error");
            }

            btn.disabled = true;
            btn.innerText = "Saving...";

            try {
                await db.collection('customers').doc(customerToEdit.id).update({
                    name: newName,
                    phone: newPhone
                });

                showToast("Customer updated ‚úÖ");
                closeEditCustomerModal();
            } catch (err) {
                console.error("Edit Customer Error:", err);
                showToast("Error updating customer", "error");
            } finally {
                btn.disabled = false;
                btn.innerText = "Save Changes";
            }
        }

        // UI Functions
        function showScreen(id) {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
        }

        function switchAuthTab(tab) {
            const tabs = document.querySelectorAll('.auth-tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            // Clear errors
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('register-error').style.display = 'none';

            if (tab === 'login') {
                document.getElementById('tab-login-label').classList.add('active');
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('register-form').style.display = 'none';
            } else {
                document.getElementById('tab-register-label').classList.add('active');
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ur' : 'en';
            updateLanguageUI();
        }

        function updateLanguageUI() {
            const t = translations[currentLang];
            const isUrdu = currentLang === 'ur';

            // Apply fonts and direction
            document.body.classList.toggle('urdu-font', isUrdu);
            
            // Labels
            document.getElementById('auth-subtitle').innerText = t.authSubtitle;
            document.getElementById('tab-login-label').innerText = t.login;
            document.getElementById('tab-register-label').innerText = t.register;
            document.getElementById('label-email').innerText = t.email;
            document.getElementById('label-password').innerText = t.password;
            document.getElementById('btn-login').innerText = t.login;
            document.getElementById('label-shop-name').innerText = t.shopName;
            document.getElementById('label-reg-email').innerText = t.email;
            document.getElementById('label-reg-password').innerText = t.password;
            document.getElementById('label-confirm-password').innerText = t.confirmPassword;
            document.getElementById('btn-register').innerText = t.createAccount;
            
            document.getElementById('btn-logout').innerText = t.logout;
            document.getElementById('summary-total-customers').innerText = t.totalCustomers;
            document.getElementById('summary-total-udhaar').innerText = t.totalUdhaar;
            document.getElementById('summary-received-today').innerText = t.receivedToday;
            
            document.getElementById('title-add-customer').innerText = t.addNewCustomer;
            document.getElementById('label-cust-name').innerText = t.customerName;
            document.getElementById('label-cust-phone').innerText = t.phoneNumber;
            document.getElementById('label-cust-amount').innerText = t.udhaarAmount;
            document.getElementById('label-cust-date').innerText = t.date;
            document.getElementById('label-cust-notes').innerText = t.notes;
            document.getElementById('btn-add-customer').innerText = t.addCustomer;
            
            document.getElementById('search-input').placeholder = t.searchPlaceholder;
            document.getElementById('footer-text').innerText = t.footer;

            // Re-render list to update card labels
            renderCustomerList(customers);
        }

        // Auth Logic
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            errorDiv.style.display = 'none';

            if (!email || !pass) {
                errorDiv.innerText = translations[currentLang].fillRequired;
                errorDiv.style.display = 'block';
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, pass);
                showToast(translations[currentLang].loginSuccess);
            } catch (err) {
                errorDiv.innerText = "Invalid email or password";
                errorDiv.style.display = 'block';
            }
        }

        async function handleRegister() {
            const shop = document.getElementById('reg-shop-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            const confirm = document.getElementById('reg-confirm-password').value;
            const errorDiv = document.getElementById('register-error');
            errorDiv.style.display = 'none';

            if (!shop || !email || !pass || !confirm) {
                errorDiv.innerText = translations[currentLang].fillRequired;
                errorDiv.style.display = 'block';
                return;
            }
            if (pass.length < 6) {
                errorDiv.innerText = "Password must be at least 6 characters";
                errorDiv.style.display = 'block';
                return;
            }
            if (pass !== confirm) {
                errorDiv.innerText = translations[currentLang].passMismatch;
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection('users').doc(cred.user.uid).set({
                    shopName: shop,
                    email: email
                });
                showToast(translations[currentLang].regSuccess);
            } catch (err) {
                errorDiv.innerText = err.message;
                errorDiv.style.display = 'block';
            }
        }

        function handleLogout() {
            auth.signOut().then(() => {
                // Clear local state
                customers = [];
                shopName = "";
                document.getElementById('display-shop-name').innerText = "";
                switchAuthTab('login'); // Reset to login tab
            });
        }

        function handleDatabaseMissing() {
            showScreen('dashboard-screen');
            const container = document.getElementById('customer-list');
            container.innerHTML = `
                <div style="text-align:center; padding: 40px; color: var(--danger); background: #FFF0F0; border-radius: 12px; border: 1px solid var(--danger); margin: 20px;">
                    <h3 style="margin-bottom:10px;">‚ö†Ô∏è Firestore Database Not Found</h3>
                    <p>The database (default) does not exist for this project.</p>
                    <p style="font-size: 13px; margin-top: 10px; color: #666;">Please go to your Firebase Console and click "Create Database" to start using the app.</p>
                    <a href="https://console.firebase.google.com/project/udhaar-tracker-e3543/firestore" target="_blank" style="display:inline-block; margin-top:20px; background: var(--danger); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold;">Create Database Now ‚Üí</a>
                </div>
            `;
            showToast("Database not found.", "error");
        }

        function handlePermissionDenied() {
            showScreen('dashboard-screen');
            const container = document.getElementById('customer-list');
            container.innerHTML = `
                <div style="text-align:center; padding: 40px; color: #856404; background: #FFF3CD; border-radius: 12px; border: 1px solid #FFEEBA; margin: 20px;">
                    <h3 style="margin-bottom:10px;">üîí Permission Denied</h3>
                    <p>Your Firestore Security Rules are blocking access.</p>
                    <p style="font-size: 13px; margin-top: 10px;"><b>Step 1:</b> Go to Firebase Console > Firestore > Rules</p>
                    <p style="font-size: 13px;"><b>Step 2:</b> Paste these rules and click <b>Publish</b>:</p>
                    <div style="text-align:left; font-size: 11px; background: #fff; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid #FFEEBA; font-family: monospace; white-space: pre-wrap; overflow-x: auto;">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /customers/{doc} {
      allow read, write: if request.auth != null && (resource == null || resource.data.userId == request.auth.uid) && (request.resource == null || request.resource.data.userId == request.auth.uid);
    }
    match /payments/{doc} {
      allow read, write: if request.auth != null && (resource == null || resource.data.userId == request.auth.uid) && (request.resource == null || request.resource.data.userId == request.auth.uid);
    }
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}</div>
                    <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
                        <a href="https://console.firebase.google.com/project/udhaar-tracker-e3543/firestore/rules" target="_blank" style="background: #856404; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 14px;">Go to Rules Tab ‚Üí</a>
                        <button onclick="location.reload()" style="background: white; border: 1px solid #856404; color: #856404; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;">üîÑ Retry</button>
                    </div>
                </div>
            `;
            showToast("Permission denied. Check Rules.", "error");
        }

        function handleIndexError(err) {
            const indexUrl = err.message.split('here: ')[1] || "https://console.firebase.google.com/project/udhaar-tracker-e3543/firestore/indexes";
            showScreen('dashboard-screen');
            const container = document.getElementById('customer-list');
            container.innerHTML = `
                <div style="text-align:center; padding: 40px; color: #004085; background: #cce5ff; border-radius: 12px; border: 1px solid #b8daff; margin: 20px;">
                    <h3 style="margin-bottom:10px;">‚ö° Index Required</h3>
                    <p>Firestore needs a "Composite Index" for this query.</p>
                    <div style="margin-top:20px; display:flex; flex-direction:column; gap:12px; align-items:center;">
                        <a href="${indexUrl}" target="_blank" style="background: #004085; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 15px; box-shadow: 0 4px 12px rgba(0,64,133,0.3);">1. Create Index in Firebase Console ‚Üí</a>
                        <p style="font-size: 12px; color: #444;">(Wait 2-3 minutes for it to build, then click retry)</p>
                        <button onclick="location.reload()" style="background: white; border: 1px solid #004085; color: #004085; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;">2. üîÑ Refresh App</button>
                    </div>
                </div>
            `;
            showToast("Index required. Click link to fix.", "error");
        }

        // Data Logic
        async function fetchData() {
            if (!currentUser) return;
            document.getElementById('cust-date').valueAsDate = new Date();

            db.collection('customers')
                .where('userId', '==', currentUser.uid)
                .onSnapshot(snapshot => {
                    customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderSummary();
                    renderCustomerList(customers);
                }, error => {
                    console.error("Firestore Error:", error);
                    if (error.code === 'permission-denied') {
                        handlePermissionDenied();
                    } else if (error.message.includes('API has not been used') || error.code === 'not-found' || error.message.includes('not exist')) {
                        handleDatabaseMissing();
                    }
                });
        }

        function renderSummary() {
            if (!currentUser) return;
            const t = translations[currentLang];
            document.getElementById('count-customers').innerText = customers.length;
            
            const totalOutstanding = customers.reduce((sum, c) => sum + c.remainingAmount, 0);
            document.getElementById('total-outstanding').innerText = `Rs. ${totalOutstanding.toLocaleString()}`;

            // Calculate received today
            const today = new Date().setHours(0,0,0,0);
            db.collection('payments')
                .where('userId', '==', currentUser.uid)
                .where('date', '>=', firebase.firestore.Timestamp.fromDate(new Date(today)))
                .get()
                .then(snap => {
                    const receivedToday = snap.docs.reduce((sum, d) => sum + d.data().amount, 0);
                    document.getElementById('total-received-today').innerText = `Rs. ${receivedToday.toLocaleString()}`;
                })
                .catch(err => {
                    console.error("Summary Error:", err);
                    if (err.message.includes('requires an index')) {
                        handleIndexError(err);
                    }
                });
        }

        async function addCustomer() {
            if (isSubmitting) return;

            const nameInput = document.getElementById('cust-name');
            const phoneInput = document.getElementById('cust-phone');
            const amountInput = document.getElementById('cust-amount');
            const dateInput = document.getElementById('cust-date');
            const notesInput = document.getElementById('cust-notes');
            const btn = document.getElementById('btn-add-customer');

            const name = nameInput.value.trim();
            const phone = phoneInput.value;
            const amount = parseFloat(amountInput.value);
            const date = dateInput.value;
            const notes = notesInput.value;

            if (!name || isNaN(amount)) return showToast(translations[currentLang].fillRequired, 'error');

            // Duplicate check (Name or Phone)
            const newNameLower = name.toLowerCase();
            const newPhoneClean = phone.replace(/[^0-9]/g, '');
            
            const existing = customers.find(c => {
                const nameMatch = c.name.trim().toLowerCase() === newNameLower;
                const phoneMatch = phone && c.phone && c.phone.replace(/[^0-9]/g, '') === newPhoneClean;
                return nameMatch || phoneMatch;
            });

            if (existing) {
                const msg = existing.name.toLowerCase() === newNameLower 
                    ? `‚ö†Ô∏è Customer '${name}' already exists!` 
                    : `‚ö†Ô∏è Phone number '${phone}' is already used by ${existing.name}!`;
                showToast(msg, 'error');
                return;
            }

            // Bug 1: Form Submission Lock
            isSubmitting = true;
            btn.disabled = true;
            const originalBtnText = btn.innerText;
            btn.innerText = currentLang === 'en' ? "Saving..." : "ŸÖÿ≠ŸÅŸàÿ∏ €ÅŸà ÿ±€Åÿß €Å€í...";

            try {
                if (!currentUser) throw new Error("User not authenticated");
                await db.collection('customers').add({
                    userId: currentUser.uid,
                    name,
                    phone,
                    originalAmount: amount,
                    remainingAmount: amount,
                    totalPaid: 0,
                    notes,
                    dateAdded: firebase.firestore.Timestamp.fromDate(new Date(date)),
                    isCleared: false
                });

                // Clear form
                nameInput.value = '';
                phoneInput.value = '';
                amountInput.value = '';
                dateInput.valueAsDate = new Date();
                notesInput.value = '';
                showToast(translations[currentLang].custAdded);
            } catch (err) {
                showToast(translations[currentLang].error, 'error');
                console.error(err);
            } finally {
                isSubmitting = false;
                btn.disabled = false;
                btn.innerText = originalBtnText;
            }
        }

        function filterCustomers() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = customers.filter(c => c.name.toLowerCase().includes(query));
            renderCustomerList(filtered);
        }

        function renderCustomerList(list) {
            const container = document.getElementById('customer-list');
            const t = translations[currentLang];
            
            if (list.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding: 40px; color: var(--text-secondary);">${t.noCustomers}</div>`;
                return;
            }

            container.innerHTML = list.map(c => {
                const initial = c.name.charAt(0).toUpperCase();
                const dateStr = c.dateAdded.toDate().toLocaleDateString();
                const isCleared = c.remainingAmount <= 0;

                return `
                    <div class="card customer-card ${isCleared ? 'cleared' : ''}" id="card-${c.id}">
                        <div class="customer-header">
                            <div class="customer-info">
                                <div class="avatar">${initial}</div>
                                <div class="customer-name-phone">
                                    <h4>${c.name} <button class="btn-edit-cust" onclick="openEditCustomerModal('${c.id}')">‚úèÔ∏è</button></h4>
                                    <p>${c.phone || 'No Phone'}</p>
                                </div>
                            </div>
                            <div class="customer-balance">
                                ${isCleared ? `<div class="cleared-badge">${t.cleared}</div>` : ''}
                                <div class="balance-amount">Rs. ${c.remainingAmount.toLocaleString()}</div>
                                <div class="balance-label">${t.remaining}</div>
                            </div>
                        </div>

                        <div class="customer-stats">
                            <div class="stat-item">
                                <span>${t.udhaarAmount}</span>
                                <p>Rs. ${c.originalAmount.toLocaleString()}</p>
                            </div>
                            <div class="stat-item">
                                <span>${t.paid}</span>
                                <p style="color: var(--success)">Rs. ${c.totalPaid.toLocaleString()}</p>
                            </div>
                            <div class="stat-item">
                                <span>${t.date}</span>
                                <p>${dateStr}</p>
                            </div>
                        </div>

                        ${c.notes ? `<div class="customer-notes">${c.notes}</div>` : ''}

                        <div class="customer-actions">
                            <button class="btn btn-outline-success" onclick="togglePaymentForm('${c.id}')">üíö ${t.receivePayment}</button>
                            <button class="btn btn-outline-gold" onclick="toggleHistory('${c.id}')">üìã ${t.paymentHistory}</button>
                            <button class="btn btn-outline-blue" onclick="printKhata('${c.id}')">üñ®Ô∏è ${t.printKhata}</button>
                            <button class="btn btn-outline-gold" onclick="sendWhatsAppReminder('${c.id}')">üì≤ WhatsApp Reminder</button>
                            <button class="btn btn-outline-danger" onclick="deleteCustomer('${c.id}', '${c.name}')">üóëÔ∏è ${t.delete}</button>
                        </div>

                        <!-- Inline Payment Form -->
                        <div class="inline-form" id="pay-form-${c.id}">
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>${t.amountReceived}</label>
                                    <input type="number" id="pay-amount-${c.id}" placeholder="Rs.">
                                </div>
                                <div class="form-group">
                                    <label>${t.paymentNote}</label>
                                    <input type="text" id="pay-note-${c.id}" placeholder="e.g. Cash received">
                                </div>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-primary" style="flex:2" onclick="savePayment('${c.id}')">${t.savePayment}</button>
                                <button class="btn btn-outline-gold" style="flex:1" onclick="togglePaymentForm('${c.id}')">${t.cancel}</button>
                            </div>
                        </div>

                        <!-- Payment History Table -->
                        <div class="history-table-container" id="history-${c.id}">
                            <table id="table-${c.id}">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Note</th>
                                        <th>Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="history-body-${c.id}">
                                    <!-- Rows injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Action Handlers
        function togglePaymentForm(id) {
            const form = document.getElementById(`pay-form-${id}`);
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
        }

        async function toggleHistory(id) {
            if (!currentUser) return;
            const container = document.getElementById(`history-${id}`);
            if (container.style.display === 'block') {
                container.style.display = 'none';
                return;
            }

            const tbody = document.getElementById(`history-body-${id}`);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Loading...</td></tr>';
            container.style.display = 'block';

            try {
                const snap = await db.collection('payments')
                    .where('userId', '==', currentUser.uid)
                    .where('customerId', '==', id)
                    .orderBy('date', 'desc')
                    .get();

                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">No payments yet</td></tr>';
                    return;
                }

                tbody.innerHTML = snap.docs.map(d => {
                    const p = d.data();
                    return `
                        <tr>
                            <td>${p.date.toDate().toLocaleDateString()}</td>
                            <td style="color: var(--success); font-weight:600">Rs. ${p.amount.toLocaleString()}</td>
                            <td>${p.note || '-'}</td>
                            <td style="font-weight:600">Rs. ${p.balanceAfter.toLocaleString()}</td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                console.error("History Error:", err);
                if (err.message.includes('requires an index')) {
                    handleIndexError(err);
                } else {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red">Error loading history</td></tr>`;
                }
            }
        }

        async function savePayment(id) {
            const amountInput = document.getElementById(`pay-amount-${id}`);
            const amount = parseFloat(amountInput.value);
            const noteInput = document.getElementById(`pay-note-${id}`);
            const note = noteInput.value;
            const t = translations[currentLang];

            const customerIndex = customers.findIndex(c => c.id === id);
            if (customerIndex === -1) return;
            const customer = customers[customerIndex];

            // 5. Validate payment amount
            if (isNaN(amount) || amount <= 0) {
                return showToast(t.fillRequired, 'error');
            }
            if (amount > customer.remainingAmount) {
                const errorMsg = currentLang === 'en' ? "Amount exceeds remaining balance ‚ùå" : "ÿ±ŸÇŸÖ ÿ®ÿßŸÇ€å ÿßÿØ⁄æÿßÿ± ÿ≥€í ÿ≤€åÿßÿØ€Å €Å€í ‚ùå";
                return showToast(errorMsg, 'error');
            }

            try {
                if (!currentUser) throw new Error("User not authenticated");
                const newRemaining = customer.remainingAmount - amount;
                const newTotalPaid = customer.totalPaid + amount;

                // 2. Firestore updates using increment
                await db.collection('customers').doc(id).update({
                    remainingAmount: firebase.firestore.FieldValue.increment(-amount),
                    totalPaid: firebase.firestore.FieldValue.increment(amount),
                    isCleared: newRemaining <= 0
                });

                // 4. Save payment record
                await db.collection('payments').add({
                    customerId: id,
                    userId: currentUser.uid,
                    amount: amount,
                    note: note,
                    date: firebase.firestore.Timestamp.now(),
                    balanceAfter: newRemaining
                });

                // 3. Update local memory array instantly
                customers[customerIndex].remainingAmount = newRemaining;
                customers[customerIndex].totalPaid = newTotalPaid;
                customers[customerIndex].isCleared = newRemaining <= 0;

                // Re-render and update UI
                renderCustomerList(customers);
                renderSummary();
                togglePaymentForm(id);
                showToast(t.payReceived);
                
                // Clear inputs
                amountInput.value = '';
                noteInput.value = '';

            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        function deleteCustomer(id, name) {
            customerToDelete = { id, name };
            const modal = document.getElementById('delete-modal');
            const modalBody = document.getElementById('modal-body');
            const confirmBtn = document.getElementById('confirm-delete-btn');

            modalBody.innerText = currentLang === 'en' 
                ? `Are you sure you want to delete ${name}? This action cannot be undone.`
                : `⁄©€åÿß ÿ¢Ÿæ ŸàÿßŸÇÿπ€å ${name} ⁄©Ÿà ÿ≠ÿ∞ŸÅ ⁄©ÿ±ŸÜÿß ⁄Üÿß€Åÿ™€í €Å€å⁄∫ÿü €å€Å ÿπŸÖŸÑ ŸàÿßŸæÿ≥ ŸÜ€Å€å⁄∫ €ÅŸà ÿ≥⁄©ÿ™ÿß€î`;
            
            confirmBtn.onclick = confirmDeleteAction;
            modal.style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').style.display = 'none';
            customerToDelete = null;
        }

        async function confirmDeleteAction() {
            if (!customerToDelete) return;
            const { id, name } = customerToDelete;
            const t = translations[currentLang];
            
            closeDeleteModal();

            try {
                // Delete from Firestore
                await db.collection('customers').doc(id).delete();
                
                // Delete all payments
                const payments = await db.collection('payments')
                    .where('userId', '==', currentUser.uid)
                    .where('customerId', '==', id)
                    .get();
                const batch = db.batch();
                payments.forEach(p => batch.delete(p.ref));
                await batch.commit();

                // Update local memory instantly
                customers = customers.filter(c => c.id !== id);
                
                // Re-render UI
                renderCustomerList(customers);
                renderSummary();
                
                showToast(t.custDeleted);
            } catch (err) {
                showToast(t.error, 'error');
                console.error(err);
            }
        }

        function sendWhatsAppReminder(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer || !customer.phone) {
                return showToast("‚ö†Ô∏è No phone number for this customer", "error");
            }

            // Phone conversion: 0300-1234567 -> 923001234567
            let cleanPhone = customer.phone.replace(/[^0-9]/g, '');
            if (cleanPhone.startsWith('0')) {
                cleanPhone = '92' + cleanPhone.substring(1);
            } else if (!cleanPhone.startsWith('92')) {
                cleanPhone = '92' + cleanPhone;
            }

            const message = `Assalam o Alaikum ${customer.name} bhai,

Aap ka ${shopName} mein udhaar ka hisaab:

Kul Udhaar: Rs. ${customer.originalAmount.toLocaleString()}
Ada Shuda: Rs. ${customer.totalPaid.toLocaleString()}
Baqi Raqam: Rs. ${customer.remainingAmount.toLocaleString()}

Meherbani farma kar jald ada karein.
Shukriya üôè

${shopName}`;

            const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        async function printKhata(id) {
            if (!currentUser) return;
            const customer = customers.find(c => c.id === id);
            
            try {
                const paymentsSnap = await db.collection('payments')
                    .where('userId', '==', currentUser.uid)
                    .where('customerId', '==', id)
                    .orderBy('date', 'desc')
                    .get();
                const payments = paymentsSnap.docs.map(d => d.data());

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const margin = 20;
                let y = 0;

                // SECTION 1 ‚Äî HEADER
                doc.setFillColor(201, 168, 76); // #C9A84C
                doc.rect(0, 0, 210, 25, 'F');
                
                if (logoUrl) {
                    try {
                        // Attempt to add logo
                        doc.addImage(logoUrl, 'JPEG', 10, 5, 15, 15);
                    } catch (e) {
                        console.warn("Could not add logo to PDF:", e);
                    }
                }

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont("helvetica", "bold");
                doc.text(shopName.toUpperCase(), 105, 12, { align: "center" });
                doc.setFontSize(14);
                doc.setFont("helvetica", "normal");
                doc.text("Udhaar Khata ‚Äî Credit Record", 105, 19, { align: "center" });

                y = 40;
                doc.setTextColor(0, 0, 0);

                // SECTION 2 ‚Äî CUSTOMER INFO
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.text("Customer Details", margin, y);
                doc.text("Invoice Details", 140, y);
                
                y += 6;
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.setFont("helvetica", "bold");
                doc.text(customer.name, margin, y);
                doc.text(`Receipt No: UK-${id.substring(0, 6).toUpperCase()}`, 140, y);
                
                y += 6;
                doc.setFont("helvetica", "normal");
                doc.setTextColor(100, 100, 100);
                doc.text(`Phone: ${customer.phone || 'N/A'}`, margin, y);
                doc.text(`Print Date: ${new Date().toLocaleDateString()}`, 140, y);
                
                y += 6;
                doc.text(`Date Opened: ${customer.dateAdded.toDate().toLocaleDateString()}`, margin, y);
                
                // Status Box
                const isCleared = customer.remainingAmount <= 0;
                if (isCleared) {
                    doc.setFillColor(46, 125, 50); // Green
                    doc.rect(140, y + 2, 30, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFont("helvetica", "bold");
                    doc.text("CLEARED", 155, y + 7.5, { align: "center" });
                } else {
                    doc.setFillColor(198, 40, 40); // Red
                    doc.rect(140, y + 2, 35, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFont("helvetica", "bold");
                    doc.text("OUTSTANDING", 157.5, y + 7.5, { align: "center" });
                }
                
                y += 20;

                // SECTION 3 ‚Äî SUMMARY BOX
                doc.setFillColor(255, 248, 231); // #FFF8E7
                doc.setDrawColor(201, 168, 76); // #C9A84C
                doc.rect(margin, y, 170, 30, 'FD');
                
                y += 8;
                doc.setTextColor(0, 0, 0);
                doc.setFont("helvetica", "normal");
                doc.text("Original Udhaar:", margin + 5, y);
                doc.text(`Rs. ${customer.originalAmount.toLocaleString()}`, 185, y, { align: "right" });
                
                y += 8;
                doc.setTextColor(46, 125, 50); // Green
                doc.text("Total Paid:", margin + 5, y);
                doc.text(`Rs. ${customer.totalPaid.toLocaleString()}`, 185, y, { align: "right" });
                
                y += 8;
                if (isCleared) {
                    doc.setTextColor(46, 125, 50); // Green
                } else {
                    doc.setTextColor(198, 40, 40); // Red
                }
                doc.setFont("helvetica", "bold");
                doc.text("Remaining Balance:", margin + 5, y);
                doc.text(`Rs. ${customer.remainingAmount.toLocaleString()}`, 185, y, { align: "right" });
                
                y += 20;

                // SECTION 4 ‚Äî PAYMENT TABLE
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(13);
                doc.setFont("helvetica", "bold");
                doc.text("Payment History", margin, y);
                
                y += 8;
                // Table Header
                doc.setFillColor(201, 168, 76); // #C9A84C
                doc.rect(margin, y, 170, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text("#", margin + 5, y + 5.5);
                doc.text("Date", margin + 15, y + 5.5);
                doc.text("Amount", margin + 50, y + 5.5);
                doc.text("Note", margin + 85, y + 5.5);
                doc.text("Balance", margin + 145, y + 5.5);
                
                y += 8;
                doc.setTextColor(0, 0, 0);
                doc.setFont("helvetica", "normal");
                
                payments.forEach((p, index) => {
                    if (y > 260) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    // Alternating rows
                    if (index % 2 === 1) {
                        doc.setFillColor(255, 253, 245); // #FFFDF5
                        doc.rect(margin, y, 170, 8, 'F');
                    }
                    
                    doc.setDrawColor(232, 213, 163); // #E8D5A3
                    doc.line(margin, y + 8, 190, y + 8); // Row border
                    
                    doc.text((index + 1).toString(), margin + 5, y + 5.5);
                    doc.text(p.date.toDate().toLocaleDateString(), margin + 15, y + 5.5);
                    doc.text(`Rs. ${p.amount.toLocaleString()}`, margin + 50, y + 5.5);
                    doc.text(p.note || "-", margin + 85, y + 5.5);
                    doc.text(`Rs. ${p.balanceAfter.toLocaleString()}`, margin + 145, y + 5.5);
                    
                    y += 8;
                });

                // SECTION 5 ‚Äî PDF FOOTER
                doc.setDrawColor(201, 168, 76);
                doc.setLineWidth(0.5);
                doc.line(margin, 280, 190, 280);
                
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text("Generated by Udhaar Tracker", margin, 285);
                doc.text(`${new Date().toLocaleString()}`, 190, 285, { align: "right" });

                const dateStr = new Date().toISOString().split('T')[0];
                doc.save(`Khata-${customer.name.replace(/\s+/g, '-')}-${dateStr}.pdf`);
            } catch (err) {
                console.error("Print Error:", err);
                if (err.message.includes('requires an index')) {
                    handleIndexError(err);
                } else {
                    showToast("Error generating PDF", "error");
                }
            }
        }
    </script>
</body>
</html>
